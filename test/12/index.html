<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>ITEC 4020 Assignment 1</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            var $container = $("#container");
            var currentIndex = 0;
            var totalCount = 0;
            var pubmedArticleArr=[];
            var startTime = new Date().getTime();

            $.ajax({
                dataType: "json",
                url: 'controller.php?action=getArticleTitleArr',
                success: function(json){
                    var articleTitleArr = json.result;
                    var articleTitleArrLength = articleTitleArr.length;
                    totalCount = articleTitleArrLength;
                    $container.append("[Success] Extract data from Data XML.("+articleTitleArrLength+")<br>");
//                    articleTitleArrLength =3;
//                    totalCount = 3;
                    for(var i=0; i<articleTitleArrLength; i++){
                        getPMID(articleTitleArr[i]);
                    }
                }
            });


            function getPMID(articleTitle){
                $.ajax({
                    dataType: "json",
                    type:"POST",
                    url: 'controller.php?action=getPMID',
                    data:{'articleTitle': articleTitle},
                    success: function(json){
                        currentIndex++;
                        $container.append("[Success] PMID get"+currentIndex+"/"+totalCount+"<br>");
                        var pubmedArticleObj = {PMID:json.result,ArticleTitle:articleTitle}
                        pubmedArticleArr.push(pubmedArticleObj);
                        if(currentIndex >= totalCount){
                            saveXML(pubmedArticleArr);
                        }
                    }
                });
            }

            function saveXML(pubmedArticleArr){
                $.ajax({
                    dataType: "json",
                    type:"POST",
                    url: 'controller.php?action=saveXML',
                    data:{'data': pubmedArticleArr},
                    success: function(json){
                        $container.append("<br>XML file generate "+json.result+"!");
                        endtime = new Date().getTime();
                        $container.append("<br>elapsed time:"+(endtime-startTime)/1000);
                    }
                });
            }


        })
    </script>
</head>
<body>
<div id="container"></div>
</body>
</html>